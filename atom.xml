<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Arvin&#39;s blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-05-31T10:03:12.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Arvin&#39;s</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>记wkWebview获取网页图片</title>
    <link href="http://yoursite.com/2017/05/27/wkWebview-get-html-img/"/>
    <id>http://yoursite.com/2017/05/27/wkWebview-get-html-img/</id>
    <published>2017-05-27T07:21:12.000Z</published>
    <updated>2017-05-31T10:03:12.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oonis1a4c.bkt.clouddn.com/20170527-00-blog.png" alt=""></p>
<p>前段时间有个需求，因为项目中有些banner和资讯列表，点开是网页浏览器，大部分是微信公众号的文章链接，还有一些自己的活动报名网页，需要实现类似微信公众号网页的图片点击可查看功能 。因为项目已经最低支持到 iOS 8，所以全替换成 <a href="https://developer.apple.com/reference/webkit/wkwebview" target="_blank" rel="external"><strong>wkWebview</strong></a> 组件了，这里记录下一些遇到的坑 。</p>
<h5 id="方案一："><a href="#方案一：" class="headerlink" title="方案一："></a>方案一：</h5><p>因为涉及到 <code>native</code> 和 <code>js</code> 的交互，一开始是想让前端同事那边给网页中的图片加点击事件，iOS 这边注册下约定的方法，但是因为有些是微信的公众号文章，所以没办法，为了统一还是需要在 iOS 这边注入 <code>js</code> 代码去遍历 DOM 树中的 img 标签，然后给每个 img 标签加上点击事件 。</p>
<p>参考下面第一篇文章，使用切割跳转 <code>url</code> 方法；因为使用的是 <code>wkWebview</code>，所以在初始化 <code>wkWebview</code> 的时候就注入 <code>js</code> 代码，遍历 img 标签，添加点击事件拿到被点击图片的索引 。当然想要拿到对应图片的 src 也是可以的，但是我只需要被点击的图片索引就好了 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *nativejsSource;</div><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</div><div class="line">	<span class="comment">/// 从bundle中加载js资源文件，转成oc字符串</span></div><div class="line">	nativejsSource = [<span class="built_in">NSString</span> stringWithContentsOfFile:[[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"didImageIndex"</span> ofType:<span class="string">@"js"</span>] encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>]; </div><div class="line">&#125;);</div><div class="line"><span class="comment">/// 注入js脚本代码</span></div><div class="line">[userContentController addUserScript:[[<span class="built_in">WKUserScript</span> alloc] initWithSource:nativejsSource injectionTime:<span class="built_in">WKUserScriptInjectionTimeAtDocumentStart</span> forMainFrameOnly:<span class="literal">YES</span>]];</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// js 方法，获取被点击的图片索引</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getImageIndex</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> objs = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"img"</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; objs.length; i++) &#123;</div><div class="line">        objs[i].onclick = (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</div><div class="line">                           <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                           location.href = <span class="string">"jscallbackoc://didImageIndex_*"</span>+i;</div><div class="line">                           &#125;</div><div class="line">                           &#125;)(i)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> objs.length;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现下面的 <code>WKNavigationDelegate</code> 代理方法，拦截请求的 <code>url</code>，然后切割处理 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> *  在发送请求之前，决定是否允许或取消导航</div><div class="line"> *  </div><div class="line"> *  @param webView          调用委托方法的Web视图</div><div class="line"> *  @param navigationAction 有关触发导航请求的动作的描述性信息</div><div class="line"> *  @param decisionHandler  当你的应用程序决定是允许还是取消导航时，要调用的块。 该块接受一个参数，它必须是枚举类型WKNavigationActionPolicy的常量之一。</div><div class="line"> */</div><div class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView decidePolicyForNavigationAction:(<span class="built_in">WKNavigationAction</span> *)navigationAction decisionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">WKNavigationActionPolicy</span>))decisionHandler &#123;</div><div class="line">    <span class="keyword">if</span> ([[[navigationAction.request URL] absoluteString] hasPrefix:<span class="string">@"jscallbackoc://"</span>]) &#123;</div><div class="line">        [<span class="keyword">self</span> performJSMethodWithURL:[[navigationAction.request URL] absoluteString] protocolName:<span class="string">@"jscallbackoc://"</span> performViewController:<span class="keyword">self</span>];</div><div class="line">    &#125;</div><div class="line">    decisionHandler(<span class="built_in">WKNavigationActionPolicyAllow</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>处理拦截的 <code>url</code> 字符串 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 捕获到拦截的url，进行切割处理，最终拿到被点击图片的 index</span></div><div class="line">- (<span class="keyword">void</span>)performJSMethodWithURL:(<span class="built_in">NSString</span> *)url protocolName:(<span class="built_in">NSString</span> *)name performViewController:(<span class="built_in">UIViewController</span> *)viewController &#123;</div><div class="line">    <span class="built_in">NSString</span> *path = [url substringFromIndex:name.length];</div><div class="line">    <span class="built_in">NSArray</span> *subPaths = [path componentsSeparatedByString:<span class="string">@"*"</span>];</div><div class="line">    <span class="built_in">NSString</span> *methodName = [[subPaths firstObject] stringByReplacingOccurrencesOfString:<span class="string">@"_"</span> withString:<span class="string">@":"</span>];</div><div class="line">    <span class="built_in">NSArray</span> *params = <span class="literal">nil</span>;</div><div class="line">    <span class="keyword">if</span> (subPaths.count == <span class="number">2</span>) &#123;</div><div class="line">        params = [[subPaths lastObject] componentsSeparatedByString:<span class="string">@"$"</span>];</div><div class="line">    &#125;</div><div class="line">    [viewController performSelector:<span class="built_in">NSSelectorFromString</span>(methodName) withObjects:params];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - private method</span></div><div class="line">- (<span class="keyword">id</span>)performSelector:(SEL)selector withObjects:(<span class="built_in">NSArray</span> *)objects &#123;</div><div class="line">    </div><div class="line">    <span class="comment">/// 方法签名(对方法的描述)</span></div><div class="line">    <span class="built_in">NSMethodSignature</span> *signature = [[<span class="keyword">self</span> <span class="keyword">class</span>] instanceMethodSignatureForSelector:selector];</div><div class="line">    <span class="keyword">if</span> (!signature) &#123;</div><div class="line">        [<span class="built_in">NSException</span> raise:<span class="string">@"严重错误"</span> format:<span class="string">@"(%@)方法找不到"</span>, <span class="built_in">NSStringFromSelector</span>(selector)];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/* NSInvocation : 利用一个NSInvocation对象通过调用方法签名来实现对方法的调用（方法调用者、方法名、方法参数、方法返回值）</span></div><div class="line">     如果仅仅完成这步，和普通的函数调用没有区别，但是关键在于NSInvocation可以对传递进来的selector进行包装，实现可以传递无限多个参数</div><div class="line">     普通的方法调用比如: [self performSelector:&lt;#(SEL)#&gt; withObject:&lt;#(id)#&gt; withObject:&lt;#(id)#&gt;] 顶多只能传递两个参数给selector */</div><div class="line">    </div><div class="line">    <span class="built_in">NSInvocation</span> *invocation = [<span class="built_in">NSInvocation</span> invocationWithMethodSignature:signature];</div><div class="line">    <span class="comment">/// 调用者是自己</span></div><div class="line">    [invocation setTarget:<span class="keyword">self</span>];</div><div class="line">    <span class="comment">/// 调用的方法是selector</span></div><div class="line">    [invocation setSelector:selector];</div><div class="line">    </div><div class="line">    <span class="comment">/// 设置参数，可以传递无限个参数</span></div><div class="line">    <span class="comment">/// 除self、_cmd以外的参数个数</span></div><div class="line">    <span class="built_in">NSInteger</span> paramsCount = signature.numberOfArguments - <span class="number">2</span>;</div><div class="line">    <span class="comment">/// 防止函数有参数但是不传递参数时，导致崩溃</span></div><div class="line">    paramsCount = MIN(paramsCount, objects.count);</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; paramsCount; i++) &#123;</div><div class="line">        <span class="keyword">id</span> object = objects[i];</div><div class="line">        <span class="keyword">if</span> ([object isKindOfClass:[<span class="built_in">NSNull</span> <span class="keyword">class</span>]])</div><div class="line">            <span class="keyword">continue</span>; <span class="comment">/// 如果传递的参数为null，就不处理了</span></div><div class="line">        </div><div class="line">        <span class="comment">/// +2是因为第一个和第二个参数默认是self和_cmd</span></div><div class="line">        [invocation setArgument:&amp;object atIndex:i + <span class="number">2</span>];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/// 调用方法</span></div><div class="line">    [invocation invoke];</div><div class="line">    <span class="comment">/// 获取返回值</span></div><div class="line">    <span class="keyword">id</span> returnValue = <span class="literal">nil</span>;</div><div class="line">    <span class="comment">/// 有返回值类型，才去获得返回值</span></div><div class="line">    <span class="keyword">if</span> (signature.methodReturnLength) &#123;</div><div class="line">        [invocation getReturnValue:&amp;returnValue];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> returnValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后实现图片点击方法，获取到图片索引 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)didImageIndex:(<span class="built_in">NSString</span> *)index &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%zd"</span>,[index integerValue]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上只是实现了点击图片拿到图片索引，但是还没有拿到图片的 <code>url</code>，要想实现网页多图浏览效果，肯定不能点一张拿一张，那就要想办法一次拿到网页中所有图片的 <code>url</code> 存到一个数组，当点击图片的时候从数组中取到对应点击索引的图片来展示就OK了。</p>
<p>这里参考下面的第二篇文章，直接使用Google开源的HTML解析框架 <a href="https://github.com/tracy-e/OCGumbo" target="_blank" rel="external">OCGumbo</a>，基于C语言的封装，面向对象的OC语法，使用方法很简单，类似约束框架 <a href="https://github.com/SnapKit/Masonry" target="_blank" rel="external">Masonry</a> 的链式语句查找属性节点，这个文章介绍很详细，这里就不再多说，直接上代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[[[<span class="built_in">NSURLSession</span> sessionWithConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]] dataTaskWithRequest:[<span class="built_in">NSMutableURLRequest</span> requestWithURL:[<span class="built_in">NSURL</span> URLWithString:<span class="keyword">self</span>.URLString]] completionHandler:^(<span class="built_in">NSData</span> * _Nullable data, <span class="built_in">NSURLResponse</span> * _Nullable response, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">              <span class="built_in">NSHTTPURLResponse</span> *httpResponse = (<span class="built_in">NSHTTPURLResponse</span> *)response;</div><div class="line">              </div><div class="line">              <span class="keyword">if</span> (httpResponse.statusCode == <span class="number">200</span>) &#123;</div><div class="line">                  </div><div class="line">                  <span class="keyword">if</span> (<span class="keyword">self</span>.imageSrcArray.count) &#123;</div><div class="line">                      [<span class="keyword">self</span>.imageSrcArray removeAllObjects];</div><div class="line">                  &#125;</div><div class="line">                  <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">                  <span class="comment">/// 将网页URL转换成HTML字符串</span></div><div class="line">                  <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="keyword">self</span>.URLString];</div><div class="line">                  <span class="built_in">NSString</span> *htmlStr = [<span class="built_in">NSString</span> stringWithContentsOfURL:url encoding:<span class="built_in">NSUTF8StringEncoding</span> error:&amp;error];</div><div class="line">                  OCGumboDocument *document = [[OCGumboDocument alloc] initWithHTMLString:htmlStr];</div><div class="line">                  </div><div class="line">                  <span class="keyword">if</span> (document.Query(<span class="string">@"body"</span>)) &#123;</div><div class="line">                      <span class="keyword">if</span> (document.Query(<span class="string">@"body"</span>).find(<span class="string">@"img"</span>)) &#123;</div><div class="line">                          <span class="comment">/// find(@"img") 望名知意，找到'img'标签，这是一个 OCGumboElement 对象数组</span></div><div class="line">                          <span class="keyword">for</span> (OCGumboElement *element <span class="keyword">in</span> document.Query(<span class="string">@"body"</span>).find(<span class="string">@"img"</span>)) &#123;</div><div class="line">                              <span class="keyword">if</span> (element.attr(<span class="string">@"src"</span>)) &#123;</div><div class="line">                              	  <span class="comment">/// 找到'src'节点添加到数组</span></div><div class="line">                                  [<span class="keyword">self</span>.imageSrcArray addObject:element.attr(<span class="string">@"src"</span>)];</div><div class="line">                              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (element.attr(<span class="string">@"data-src"</span>)) &#123;</div><div class="line">                              	  <span class="comment">/// 微信的是变态的'data-src'节点</span></div><div class="line">                                  [<span class="keyword">self</span>.imageSrcArray addObject:element.attr(<span class="string">@"data-src"</span>)];</div><div class="line">                              &#125;</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;] resume];</div></pre></td></tr></table></figure>
<p>以上代码使用 <code>NSURLSession</code> 添加了一个请求判断，是因为如果网页请求错误，比如404，500等状态时，避免因 <code>OCGumbo</code> 遍历DOM树时找不到节点而导致Crash 。</p>
<p>到此为止，一切顺利，过了一段时间，项目上了一个报名活动，后台那边debug时发现iOS这边点击报名连续发了三次请求，而安卓那边不会，那么问题看来是出在iOS这边的代码 。经过和后台那边的调试发现所有的网页请求都会进三次断点，于是写了个简单的Demo测试只加载网页，发现并不会向后台发送三次请求[捂脸]。这样一来大概知道了问题出在哪里，一定是和获取网页图片有关，使用简单粗暴的注释大法，把上面有关代码逐步注释掉，发现是 <code>OCGumbo</code> 出了问题（误会了，其实并不是[委屈]）。直到最后找出真相：</p>
<p>第一次：<code>wkWebview</code> 正常加载网页请求；<br>第二次：使用 <code>NSURLSession</code> 发了一次请求，用于判断网页加载状态；<br>第三次：在将请求 <code>url</code> 转成HTML字符串的时候，会向后台发送一次请求，就是下面这个方法：（表示百思不得其解，但是确确实实是因为它而多发了第三次请求）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">NSString</span> *htmlStr = [<span class="built_in">NSString</span> stringWithContentsOfURL:url encoding:<span class="built_in">NSUTF8StringEncoding</span> error:&amp;error];</div></pre></td></tr></table></figure>
<p>基于上述问题，在不使用 <code>NSURLSession</code> 加判断和通过转换 <code>url</code> 为HTML字符串的情况下，放弃了使用 <code>OCGumbo</code>，而是直接使用正则匹配 。</p>
<h5 id="方案二："><a href="#方案二：" class="headerlink" title="方案二："></a>方案二：</h5><p>使用 js 选择器 <code>getElementsByTagName()</code> 来获取网页的HTML字符串，再利用正则表达式来匹配 <code>img</code> 标签，上面获取图片索引的方法还是可以继续使用，但是这里还有另外一个方法，依然是通过注入js脚本代码，参考下面的后三篇文章 。</p>
<p>在初始化 <code>wkWebview</code> 的时候，注入下面的 <code>js</code> 代码 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *nativejsSource;</div><div class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</div><div class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123; </div><div class="line">     <span class="comment">/// 从bundle中加载js资源文件，转成oc字符串</span></div><div class="line">    nativejsSource = [<span class="built_in">NSString</span> stringWithContentsOfFile:[[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"ImgAddClickEvent"</span> ofType:<span class="string">@"js"</span>] encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</div><div class="line">&#125;); </div><div class="line"><span class="comment">/// 注入js脚本代码</span></div><div class="line">[userContentController addUserScript:[[<span class="built_in">WKUserScript</span> alloc] initWithSource:nativejsSource injectionTime:<span class="built_in">WKUserScriptInjectionTimeAtDocumentEnd</span> forMainFrameOnly:<span class="literal">YES</span>]];</div><div class="line"><span class="comment">/// 添加脚本消息处理</span></div><div class="line">[userContentController addScriptMessageHandler:[[YQWeakScriptMessageDelegate alloc] initWithDelegate:<span class="keyword">self</span>] name:<span class="string">@"imageDidClick"</span>];</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 获取所有img标签</span></div><div class="line"><span class="keyword">var</span> imgs = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"img"</span>);</div><div class="line"></div><div class="line"><span class="comment">/// 获取所有的imgUrl</span></div><div class="line"><span class="keyword">var</span> imgUrls = <span class="keyword">new</span> <span class="built_in">Array</span>();</div><div class="line"></div><div class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> y = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> width = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> height = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imgs.length; i++) &#123;</div><div class="line">    <span class="keyword">var</span> img = imgs[i];</div><div class="line">    <span class="comment">/// 如果图片链接存在</span></div><div class="line">    <span class="keyword">if</span> (img.src || img.getAttribute(<span class="string">'data-src'</span>)) &#123;</div><div class="line">        <span class="comment">/// 添加到图片链接数组中</span></div><div class="line">        imgUrls.push(img.src || img.getAttribute(<span class="string">'data-src'</span>));</div><div class="line">        <span class="comment">/// 如果图片没有默认的onclick事件，且父元素不是a标签，则添加onclick事件，当用户点击时，把图片链接回传给Native</span></div><div class="line">        <span class="keyword">if</span> (!img.onclick &amp;&amp; img.parentElement.tagName !== <span class="string">"A"</span>) &#123;</div><div class="line">            <span class="comment">/// 给图片添加下标的属性</span></div><div class="line">            img.index = i;      <span class="comment">/// 记录下标</span></div><div class="line">            <span class="comment">/// 添加点击事件，并且回传选中的图片链接、下标、屏幕上的位置、全部的图片数组等</span></div><div class="line">            img.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                x = <span class="keyword">this</span>.getBoundingClientRect().left;</div><div class="line">                y = <span class="keyword">this</span>.getBoundingClientRect().top;</div><div class="line">                x = x + <span class="built_in">document</span>.documentElement.scrollLeft;</div><div class="line">                y = y + <span class="built_in">document</span>.documentElement.scrollTop;</div><div class="line">                width = <span class="keyword">this</span>.width;</div><div class="line">                height = <span class="keyword">this</span>.height;</div><div class="line">                <span class="keyword">var</span> imgInfo = &#123;</div><div class="line">                <span class="attr">imgUrl</span>: <span class="keyword">this</span>.src || <span class="keyword">this</span>.getAttribute(<span class="string">'data-src'</span>),</div><div class="line">                <span class="attr">x</span>: x,</div><div class="line">                <span class="attr">y</span>: y,</div><div class="line">                <span class="attr">width</span>: width,</div><div class="line">                <span class="attr">height</span>: height,</div><div class="line">                <span class="attr">index</span>: <span class="keyword">this</span>.index,</div><div class="line">                <span class="attr">imgUrls</span>: imgUrls</div><div class="line">                &#125;;</div><div class="line">                <span class="comment">/// UIWebView使用</span></div><div class="line">                h5ImageDidClick(imgInfo);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">h5ImageDidClick</span> (<span class="params">info</span>) </span>&#123;</div><div class="line">    <span class="comment">/// WKWebView使用</span></div><div class="line">    <span class="built_in">window</span>.webkit.messageHandlers.imageDidClick.postMessage(info);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现 <code>WKScriptMessageHandler</code> 代理方法，当点击图片的时候会获取到被点击的图片的信息，包括 src，size，index等，还有网页的图片数组 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - WKScriptMessageHandler</span></div><div class="line">- (<span class="keyword">void</span>)userContentController:(<span class="built_in">WKUserContentController</span> *)userContentController didReceiveScriptMessage:(<span class="built_in">WKScriptMessage</span> *)message &#123;</div><div class="line">    <span class="keyword">if</span> ([message.name isEqualToString:<span class="string">@"imageDidClick"</span>]) &#123;</div><div class="line">        <span class="built_in">NSDictionary</span> *dict = message.body;</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,dict);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但，上面这种做法明显是不太合理的，我们不能在每次点击都去获取所有的图片src，这样做实在太浪费性能 。所以正确做法应该是在当网页加载完成时去获取 。</p>
<p>我们实现 <code>WKNavigationDelegate</code> 代理方法，当网页加载完成时，使用 js 方法选择器获取网页HTML字符串，在 <code>getImgWithHtmlStr:callback:</code> 自定义方法中使用正则匹配网页图片 <code>img</code> 标签，完成后回调（我这里回调只是输出 log）。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)webView:(<span class="built_in">WKWebView</span> *)webView didFinishNavigation:(<span class="built_in">WKNavigation</span> *)navigation &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"webView did finish"</span>);</div><div class="line">    <span class="built_in">NSString</span> *jsToGetHTMLSource = <span class="string">@"document.getElementsByTagName('body')[0].innerHTML"</span>;</div><div class="line">    [webView evaluateJavaScript:jsToGetHTMLSource completionHandler:^(<span class="keyword">id</span> _Nullable HTMLsource, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">        [<span class="keyword">self</span> getImgWithHtmlStr:(<span class="built_in">NSString</span> *)HTMLsource callback:^(<span class="keyword">id</span> result) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,result);</div><div class="line">        &#125;];</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>正则匹配 <code>img</code> 标签，方法实现：因为是耗时操作，下面使用了 <code>GCD</code> 的异步队列任务组 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - get all image url</span></div><div class="line">- (<span class="keyword">void</span>)getImgWithHtmlStr:(<span class="built_in">NSString</span> *)htmlStr callback:(<span class="keyword">void</span> (^)(<span class="keyword">id</span>))callback &#123;</div><div class="line">    <span class="keyword">if</span> (!htmlStr || !htmlStr.length) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    [<span class="keyword">self</span> group_async_queue:^&#123;</div><div class="line">        <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</div><div class="line">        <span class="comment">/// @"&lt;img[^&gt;]+?data-src=[\"']?([^&gt;'\"]+)[\"']?"</span></div><div class="line">        <span class="built_in">NSString</span> *pattern = <span class="string">@"src=[\"']?([^&gt;'\"]+)(jpg|png|gif|jpeg)[\"']?"</span>;</div><div class="line">        <span class="comment">/// NSString *htmlStr = [NSString stringWithContentsOfURL:url encoding:NSUTF8StringEncoding error:&amp;error];</span></div><div class="line">        <span class="built_in">NSRegularExpression</span> *regular = [<span class="built_in">NSRegularExpression</span> regularExpressionWithPattern:pattern options:<span class="built_in">NSRegularExpressionCaseInsensitive</span> error:&amp;error];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (error) <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.imageSrcArray.count) &#123;</div><div class="line">            [<span class="keyword">self</span>.imageSrcArray removeAllObjects];</div><div class="line">        &#125;</div><div class="line">        [regular enumerateMatchesInString:htmlStr options:<span class="built_in">NSMatchingReportCompletion</span> range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, htmlStr.length) usingBlock:^(<span class="built_in">NSTextCheckingResult</span> * _Nullable result, <span class="built_in">NSMatchingFlags</span> flags, <span class="built_in">BOOL</span> * _Nonnull stop) &#123; </div><div class="line">            <span class="built_in">NSString</span> *imgStr = [htmlStr substringWithRange:result.range]; </div><div class="line">            <span class="keyword">if</span> (imgStr.length) &#123; </div><div class="line">                imgStr = [imgStr substringWithRange:<span class="built_in">NSMakeRange</span>(<span class="number">5</span>, imgStr.length - <span class="number">6</span>)]; </div><div class="line">                [<span class="keyword">self</span>.imageSrcArray addObject:imgStr];</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">    &#125; complete:^&#123;</div><div class="line">        <span class="keyword">if</span> (callback) callback(<span class="string">@"get all image url success!"</span>);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>GCD</code> 异步队列组方法封装，避免耗时操作导致主线程阻塞 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)group_async_queue:(<span class="keyword">void</span> (^)())queue complete:(<span class="keyword">void</span> (^)())block &#123;</div><div class="line">    <span class="comment">/// 创建队列组</span></div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    <span class="comment">/// 进入队列组</span></div><div class="line">    dispatch_group_enter(group);</div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>), ^&#123;</div><div class="line">        <span class="comment">/// 异步执行任务</span></div><div class="line">        <span class="keyword">if</span> (queue) queue();</div><div class="line">        <span class="comment">/// 离开队列组</span></div><div class="line">        dispatch_group_leave(group);</div><div class="line">    &#125;); </div><div class="line">    <span class="comment">/// 队列组执行完毕, 通知主线程</span></div><div class="line">    dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</div><div class="line">        <span class="keyword">if</span> (block) block();</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以，最终使用 方案二 解决了重复请求后台服务器的问题 。</p>
<p><strong> 参考文章：</strong><br><a href="http://www.jianshu.com/p/a388ec39e37a" target="_blank" rel="external">UIWebView保存图片</a><br><a href="http://www.jianshu.com/p/029a5ef4e86a" target="_blank" rel="external">HTML解析之Gumbom(iOS)</a><br><a href="http://www.jianshu.com/p/ac45d99cf912" target="_blank" rel="external">iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（上）</a><br><a href="http://www.jianshu.com/p/870dba42ec15" target="_blank" rel="external">iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（中）</a><br><a href="http://www.jianshu.com/p/52668d5b2e68" target="_blank" rel="external">iOS中UIWebView与WKWebView、JavaScript与OC交互、Cookie管理看我就够（下）</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oonis1a4c.bkt.clouddn.com/20170527-00-blog.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;前段时间有个需求，因为项目中有些banner和资讯列表，点开是网页浏览器，大部分是微信公众号的文章链接，还有一些自
    
    </summary>
    
      <category term="Technology" scheme="http://yoursite.com/categories/Technology/"/>
    
      <category term="iOS" scheme="http://yoursite.com/categories/Technology/iOS/"/>
    
    
      <category term="wkWebview" scheme="http://yoursite.com/tags/wkWebview/"/>
    
      <category term="HTML" scheme="http://yoursite.com/tags/HTML/"/>
    
  </entry>
  
  <entry>
    <title>Hexo 主题之 Hueman</title>
    <link href="http://yoursite.com/2017/05/19/hexo-themes-hueman/"/>
    <id>http://yoursite.com/2017/05/19/hexo-themes-hueman/</id>
    <published>2017-05-19T03:06:54.000Z</published>
    <updated>2017-05-20T12:28:33.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oonis1a4c.bkt.clouddn.com/hueman-themes.jpeg" alt=""></p>
<p>打自搭建好博客开始，默认的<a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="external">Next主题</a>实在不足以满足我的审美观(ಥ_ಥ)呀，…必须（果断）折腾！哗啦啦，直奔<a href="https://hexo.io/themes/" target="_blank" rel="external">Hexo主题库</a>，无奈选择困难症，千挑万选最终觉得<a href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="external">Hunman主题</a>比较符合我的Style~~ 好了，本文就来细讲更换Hueman主题的愉（心）快（塞）过程，业余时间断断续续的弄了好久呢 。</p>
<p>上菜：先来一份<a href="https://github.com/ppoffice/hexo-theme-hueman/wiki" target="_blank" rel="external"><strong><em>Hueman主题文档</em></strong></a>，客官请慢看，本文所写大部分在文档也能找到 。</p>
<hr>
<h5 id="一-nbsp-下载（Clone）主题到本地"><a href="#一-nbsp-下载（Clone）主题到本地" class="headerlink" title="一. &nbsp;下载（Clone）主题到本地"></a>一. &nbsp;下载（<strong>Clone</strong>）主题到本地</h5><p>使用以下任一命令Clone到本地 <strong>../themes</strong> 目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/// Clone with SSH</div><div class="line">$ git clone git@github.com:ppoffice/hexo-theme-hueman.git</div><div class="line"></div><div class="line">/// Clone with HTTPS</div><div class="line">$ git clone https://github.com/ppoffice/hexo-theme-hueman.git</div></pre></td></tr></table></figure></p>
<p>Clone 下来的主题目录结构如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── _config.yml	# 主题配置文件。修改时会自动更新，无需重启服务器；</div><div class="line">├── languages	# 语言文件夹，若要设置主题语言，修改主题配置文件；</div><div class="line">├── layout	# 布局文件夹。用于存放主题的模板文件，决定了网站内容的呈现方式；</div><div class="line">├── scripts	# 脚本文件夹。在启动时，Hexo 会载入此文件夹内的 JavaScript 文件；</div><div class="line">└── source	# 资源文件夹，除了模板以外的 Asset，例如 CSS、JavaScript 文件等，都应该放在这个文件夹中。</div></pre></td></tr></table></figure>
<p><strong> 注意：Clone下来的配置文件<code>_config.yml</code>多了<code>.example</code>后缀，手动去掉即可，否则替换主题后不生效哦！之前就是没留意到这个还以为姿势不对导致替换后没效果 。</strong></p>
<p><strong> 重要说明：在 <code>Hexo</code> 中有两份主要的配置文件，其名称都是 <code>_config.yml</code> 。 其中，一份位于<code>站点根目录</code>下，主要包含 Hexo 本身的配置；另一份位于<code>主题目录</code>下，这份配置由主题作者提供，主要用于配置主题相关的选项，所以千万不要混淆 。 为了描述方便，在以下说明中，将前者称为 <code>站点配置文件</code>， 后者称为 <code>主题配置文件</code> 。</strong> </p>
<p>替换Hexo默认主题，只需要修改 <code>站点配置文件</code> 中的 <strong> <code>theme</code> </strong> 字段值即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Extensions		# 拓展插件</div><div class="line">## Plugins: https://hexo.io/plugins/</div><div class="line">## Themes: https://hexo.io/themes/</div><div class="line">theme: hueman		# 当前主题名称。值为false时禁用主题</div></pre></td></tr></table></figure></p>
<p>是不是很简单，这样就好了，现在可以使用 <code>hexo s</code> 命令启动测试服务器看看效果啦 。</p>
<hr>
<h5 id="二-nbsp-修改主题样式"><a href="#二-nbsp-修改主题样式" class="headerlink" title="二. &nbsp;修改主题样式"></a>二. &nbsp;修改主题样式</h5><p>2.1 &nbsp;替换主题 <code>Header</code> &amp;&amp; <code>Footer</code> 背景</p>
<p>Header 路径 <code>../themes/hueman/source/css/_partial/header.styl</code> 文件 。<br>Footer 路径 <code>../themes/hueman/source/css/_partial/footer.styl</code> 文件 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/// 直接去掉这一行，不要注释，否则报错，坑</div><div class="line">- background: color-header-background</div><div class="line"></div><div class="line">/// 添加这一行，url：括号内填入图片URL地址</div><div class="line">+ background-image: url(&quot;your background image url&quot;)</div></pre></td></tr></table></figure>
<p>2.2 &nbsp;替换 <code>Logo</code> 图片</p>
<p>Logo 图片路径 <code>../themes/hueman/source/css/images/logo-header.png</code><br>直接替换一张同名（<code>logo-header.png</code>）的图片即可 。</p>
<p>如果想要设置 <code>Logo</code> 图片的Size，打开 <code>主题配置文件</code> 修改 <code>customize:</code> 字段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">customize:</div><div class="line">    logo:</div><div class="line">        width: 165</div><div class="line">        height: 60</div><div class="line">        url: images/logo-header.png</div></pre></td></tr></table></figure></p>
<hr>
<h5 id="三-nbsp-添加主题配置"><a href="#三-nbsp-添加主题配置" class="headerlink" title="三. &nbsp;添加主题配置"></a>三. &nbsp;添加主题配置</h5><p>3.1 &nbsp;添加社交链接，直接把链接地址填上去就好了，不需要的直接注释掉吧 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">social_links: # for more icons, please see http://fontawesome.io/icons/#brand</div><div class="line">      twitter: /</div><div class="line">      facebook: /</div><div class="line">      google-plus: /</div><div class="line">      github: /</div><div class="line">      weibo: /</div></pre></td></tr></table></figure>
<p>3.2 &nbsp;添加RSS订阅，首先需要安装RSS插件 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/// 执行以下命令安装 RSS 插件</div><div class="line">$ npm install hexo-generator-feed --save</div></pre></td></tr></table></figure>
<p>3.2.1 &nbsp;&nbsp;在 <code>站点配置文件</code> 中添加RSS支持 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># RSS订阅支持</div><div class="line">plugin:</div><div class="line">- hexo-generator-feed</div><div class="line"></div><div class="line"># Feed Atom</div><div class="line">feed:</div><div class="line">type: atom</div><div class="line">path: atom.xml</div><div class="line">limit: 20</div></pre></td></tr></table></figure></p>
<p>3.2.2 &nbsp;&nbsp;在 <code>主题配置文件</code> 中开启RSS订阅。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rss: /atom.xml</div></pre></td></tr></table></figure></p>
<p>附上一篇<a href="https://mritd.me/2016/03/08/Hexo%E6%B7%BB%E5%8A%A0Rss%E8%AE%A2%E9%98%85/#一安装rss插件" target="_blank" rel="external">《Hexo 添加 Rss 订阅》</a>的文章，需要的童鞋可以参考 。</p>
<p>3.3 &nbsp;添加博客评论，Hueman 支持 <code>有言</code>，<code>多说</code>，<code>disqus</code> 评论服务。 </p>
<p>1.&nbsp;&nbsp;<code>有言</code> 不知道是怎样，貌似没太多人用；<br>2.&nbsp;&nbsp;<code>多说</code> 官方最近发布消息，评论系统将于2017年6月1号正式关闭；<br>3.&nbsp;&nbsp;”<code>disqus</code> 在Quantcast的美国网络排名中以每月1.44亿独立用户访问排行第一“，这是维基百科的描述，好腻害 。可惜在大天朝需要翻墙才能用，好累啊，🙄 呵呵哒 。。</p>
<p>现在 <code>多说</code> 挂了，貌似可以选择的替换方案只有 <code>disqus</code> 比较靠谱，其它国内的不知道啥时候会步 <code>多说</code> 后尘，so~ 使用 <code>disqus</code>一劳永逸吧，而且 <code>disqus</code> 的Style是我喜欢的 。</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/disqus-screenshots.png" alt="Screenshots"></p>
<p>到<strong> <a href="https://disqus.com/" target="_blank" rel="external">Disqus</a> </strong>官网注册帐号，登录后，点击首页的 <code>GET STARTED</code> 按钮，选择 <code>I want to install Disqus on my site</code> 选项，按照步骤配置，添加站点即可；最后将你的<code>shortname</code>填到主题配置文件中就可以啦 。附上一篇<a href="http://www.jianshu.com/p/c4f65ebe23ad" target="_blank" rel="external">《为 Hexo 博客加入 Disqus 评论》</a>的文章，写的比较详细，需要的童鞋可以参考 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">comment:</div><div class="line">    disqus: 	# 这里填在Disqus上添加的站点名字就OK</div><div class="line">    duoshuo: 	# enter duoshuo shortname here</div><div class="line">    youyan: 	# enter youyan uid here</div><div class="line">    facebook:   # enter true to enable</div><div class="line">    isso: 	# enter the domain name of your own comment isso server eg. comments.example.com</div></pre></td></tr></table></figure>
<p>3.4 &nbsp;添加网站统计分析，可以使用谷歌分析或者百度分析 。</p>
<p>3.4.1    &nbsp;&nbsp;注册<a href="https://www.google.com/intl/zh-CN/analytics/" target="_blank" rel="external">谷歌分析</a>服务；<br>登录后，在 管理-&gt;跟踪信息-&gt;跟踪代码 中可以获取跟踪 ID；<br>在 <code>主题配置文件</code> 中的 <code>google_analytics:</code> 添加你的跟踪 ID 即可 。</p>
<p>3.4.2 &nbsp;&nbsp;注册<a href="https://tongji.baidu.com/web/welcome/login" target="_blank" rel="external">百度分析</a>服务；<br>登录后，在 管理-&gt;代码管理-&gt;代码获取，在 js 代码段中获取 <code>32位</code> 的哈希值；<br>在 <code>主题配置文件</code> 中的 <code>baidu_analytics:</code> 添加获取的 <code>32位</code> 百度分析哈希值即可 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">plugins:</div><div class="line">    lightgallery: true 		# options: true, false</div><div class="line">    justifiedgallery: true 	# options: true, false</div><div class="line">    google_analytics: 		# 输入您的Google Analytics（分析）的跟踪ID</div><div class="line">    baidu_analytics: 		# 输入百度分析哈希键</div><div class="line">    mathjax: false 		# options: true, false</div></pre></td></tr></table></figure>
<p>3.5 &nbsp;设置分享，分享方式有四种，默认 <code>default</code>；<br>建议使用 <code>jiathis</code> 或者 <code>bdshare</code> , <code>addtoany</code> 貌似要翻墙才能分享出去 。<br>问题：<code>jiathis</code> 和 <code>bdshare</code> <code>deploy</code> 后不知道为啥不显示被分享的服务商的图标，坑！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Share</div><div class="line">share: default # options: jiathis, bdshare, addtoany, default</div></pre></td></tr></table></figure>
<p>3.6 &nbsp;加入网站计数，推荐使用<a href="http://ibruce.info/2015/04/04/busuanzi/" target="_blank" rel="external">不蒜子网站计数</a>，<code>一行脚本+一行标签</code> 搞定，简单到爆；</p>
<p>3.6.1 &nbsp;安装脚本（Required）<br>打开路径 <code>../themes/hueman/layout/common/footer.ejs</code> 文件，插入以下脚本即可 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;script async src=&quot;//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;</div><div class="line">&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>3.6.2 &nbsp;安装标签（Optional）<br>&nbsp;&nbsp;&nbsp;<strong>a. &nbsp;显示站点总访问量：</strong><br>&nbsp;&nbsp;&nbsp;要显示站点总访问量，复制以下代码添加到你需要显示的位置 。有两种算法可选：</p>
<p>&nbsp;&nbsp;&nbsp;算法a：pv的方式，单个用户连续点击n篇文章，记录n次访问量 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;span id=&quot;busuanzi_container_site_pv&quot;&gt;</div><div class="line">    本站总访问量&lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt;次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;算法b：uv的方式，单个用户连续点击n篇文章，只记录1次访客数 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;span id=&quot;busuanzi_container_site_uv&quot;&gt;</div><div class="line">  本站访客数&lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;人次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;<strong>b. &nbsp;显示单页面访问量：</strong><br>&nbsp;&nbsp;&nbsp;要显示每篇文章的访问量，复制以下代码添加到你需要显示的位置 。</p>
<p>&nbsp;&nbsp;&nbsp;算法：pv的方式，单个用户点击1篇文章，本篇文章记录1次阅读量 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;span id=&quot;busuanzi_container_page_pv&quot;&gt;</div><div class="line">  本文总阅读量&lt;span id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt;次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure>
<p>标签代码同样是插入到 <code>../footer.ejs</code> 文件中；如果是只计数，不显示，则只安装脚本代码，不需安装标签代码 。代码中文字是可以修改的，只要保留id正确即可 。</p>
<p>3.7 &nbsp;<strong><code>// TODO:</code></strong> 站内搜索，按照<a href="https://github.com/ppoffice/hexo-theme-hueman/wiki/Search" target="_blank" rel="external">主题文档</a>安装 <code>hexo-generator-json-content</code> 插件，明明安装成功了，但是一跑测试就报错，目前还没解决，后面解决了再更新 。</p>
<hr>
<h5 id="四-nbsp-其它配置"><a href="#四-nbsp-其它配置" class="headerlink" title="四. &nbsp;其它配置"></a>四. &nbsp;其它配置</h5><p>4.1 &nbsp;About页面，刚搭建完点击About是 <code>not found</code> 吧！那是需要自己 <code>new</code> 一个才有呢 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/// 新建一个 about 页面文件</div><div class="line">$ hexo new page &quot;about&quot;</div></pre></td></tr></table></figure>
<p>以上命令会在 <code>../xxxx.github.io/source/</code> 文件夹下面生成一个 <code>about</code> 文件夹，里面会创建一个<code>index.md</code> 的文件 。同样的使用 <code>Markdown</code> 语法编辑，完成后 <code>deploy</code> 。</p>
<p>在 <code>主题配置文件</code> 中的 <code>About:</code> 字段添加路径 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">menu:</div><div class="line">    Home: /</div><div class="line">    # Delete this row if you don&apos;t want categories in your header nav bar</div><div class="line">    Categories:</div><div class="line">    About: /about/index.html</div></pre></td></tr></table></figure></p>
<p>4.2 &nbsp;添加网站友情链接 。</p>
<p>在 <code>主题配置文件</code> 中的 <code>links:</code> 字段下添加 。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">links:</div><div class="line">       Hexo: http://hexo.io</div><div class="line">       Github: https://xxxx.xx</div><div class="line">       ...</div></pre></td></tr></table></figure></p>
<p>4.3 &nbsp;<code>404 Not-Found</code> 页面，让我们一起加入<a href="http://www.qq.com/404/" target="_blank" rel="external">腾讯公益<strong>404</strong></a>吧 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/// 新建一个 404 页面文件</div><div class="line">$ hexo new page &quot;404&quot;</div></pre></td></tr></table></figure>
<p>以上命令会在 <code>../xxxx.github.io/source/</code> 文件夹下面生成一个 <code>404.html</code> 文件，拷贝以下<code>HTML</code> 代码填进去就可以了，记得改下 <code>homePageUrl</code> 为你的站点<code>URL</code>地址 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE HTML&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8;&quot;/&gt;</div><div class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge,chrome=1&quot; /&gt;</div><div class="line">  &lt;meta name=&quot;robots&quot; content=&quot;all&quot; /&gt;</div><div class="line">  &lt;meta name=&quot;robots&quot; content=&quot;index,follow&quot;/&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt; </div><div class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;http://www.qq.com/404/search_children.js&quot; charset=&quot;utf-8&quot; homePageUrl=&quot;your site url&quot; homePageName=&quot;回到我的主页&quot;&gt;&lt;/script&gt; </div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<hr>
<h5 id="五-nbsp-关于文章分类"><a href="#五-nbsp-关于文章分类" class="headerlink" title="五. &nbsp;关于文章分类"></a>五. &nbsp;关于文章分类</h5><p>5.1 &nbsp;一个小技巧，在站点目录 <code>xxxx.github.io/scaffolds/post.md</code> 文件中添加一项<code>categories</code>，这样每次新建博客文章 <code>new</code> 出来的 <code>.md</code> 文件就都带 <code>categories</code> 了，不用手动再写一遍囖，就像下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">title: &#123;&#123; title &#125;&#125;</div><div class="line">date: &#123;&#123; date &#125;&#125;</div><div class="line">categories:	/// 添加这一项</div><div class="line">tags:</div><div class="line">---</div></pre></td></tr></table></figure>
<p>5.2 &nbsp;设置分类的父子级关系，很多时候我们只需要创建少数几个大分类，里面再细分为N个小分类就好了，对于 <code>Hueman</code> 这样的主题来说可以更方便的管理文章，就像下图这样：</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/hueman-categories.png" alt="Screenshots"></p>
<p>那是怎么做呢 ？其实很简单，使用 <code>Front-matter</code> 。<br><code>Front-matter</code> 是文件最上方以 <code>---</code> 分隔的区域，用于指定个别文件的变量，就像这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">title: Hexo 主题之 Hueman</div><div class="line">date: 2017-05-19 11:06:54 </div><div class="line">categories:	</div><div class="line">	- Technology</div><div class="line">	- Themes </div><div class="line">tags:		</div><div class="line">	- Hexo</div><div class="line">	- Themes</div><div class="line">---</div></pre></td></tr></table></figure>
<p>只有文章支持分类和标签，你可以在 <code>Front-matter</code> 中设置 。<br>在上面的 <code>categories:</code> 参数中，依次下来就会使分类 <code>Technology</code> 成为 <code>Themes</code> 的父分类，父分类总是排在第一位，以下均为子分类 。<br>而 <code>tags:</code> 参数则是为这篇文章打的标签，同样是可以添加多个，没有父子级标签之说 。</p>
<p><strong><em> 写到这里基本上把 Hueman 折腾得差不多了，以后还有其它的细节想起来再更新囖！</em></strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oonis1a4c.bkt.clouddn.com/hueman-themes.jpeg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;打自搭建好博客开始，默认的&lt;a href=&quot;https://github.com/iissnan/hexo-theme
    
    </summary>
    
      <category term="Technology" scheme="http://yoursite.com/categories/Technology/"/>
    
      <category term="Themes" scheme="http://yoursite.com/categories/Technology/Themes/"/>
    
    
      <category term="Hexo" scheme="http://yoursite.com/tags/Hexo/"/>
    
      <category term="Themes" scheme="http://yoursite.com/tags/Themes/"/>
    
  </entry>
  
  <entry>
    <title>友盟推送之-踩坑</title>
    <link href="http://yoursite.com/2017/05/01/on-umeng-push/"/>
    <id>http://yoursite.com/2017/05/01/on-umeng-push/</id>
    <published>2017-05-01T01:16:15.000Z</published>
    <updated>2017-05-31T06:26:25.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oonis1a4c.bkt.clouddn.com/umeng-push.png" alt=""></p>
<p>最近项目需要做消息推送，于是决定使用第三方推送服务（为了方便后台统一iOS和Android的消息管理）；目前做消息推送的服务商有很多，综合考虑决定集成友盟+的，主要是不想在项目中集成太多类似的第三方SDK，而且在这之前已经使用了友盟的统计和分享功能，口碑也还算不错，所以就统一了，也方便管理 。</p>
<p>上友盟官网下载最新的<code>SDK</code>，这里吐槽一下，竟然不支持<code>CocoaPods</code>集成，需要手动导入<code>SDK</code>包到项目，无疑又给我们的<code>ipa</code>包增加体积 。接下来就是按照友盟<a href="http://dev.umeng.com/push/ios/integration" target="_blank" rel="external">iOS SDK文档</a>步骤来集成，文档还算比较全，相信大家并没什么难度 。</p>
<h4 id="一-初始化并注册友盟推送："><a href="#一-初始化并注册友盟推送：" class="headerlink" title="一. 初始化并注册友盟推送："></a>一. 初始化并注册友盟推送：</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">    <span class="comment">/// 绑定App的appKey和启动参数，启动消息参数用于处理用户通过消息打开应用相关信息</span></div><div class="line">    [UMessage startWithAppkey:kAppKey launchOptions:launchOptions httpsEnable:<span class="literal">YES</span>];</div><div class="line"><span class="meta">#ifdef DEBUG</span></div><div class="line">    [UMessage openDebugMode:<span class="literal">YES</span>];</div><div class="line">    [UMessage setLogEnabled:<span class="literal">YES</span>];</div><div class="line"><span class="meta">#else</span></div><div class="line">    [UMessage openDebugMode:<span class="literal">NO</span>];</div><div class="line">    [UMessage setLogEnabled:<span class="literal">NO</span>];</div><div class="line"><span class="meta">#endif</span></div><div class="line">    </div><div class="line">    <span class="comment">/// 注册远程推送</span></div><div class="line">    [UMessage registerForRemoteNotifications];</div></pre></td></tr></table></figure>
<p>iOS 10之后苹果统一了推送API，使用<code>UNUserNotificationCenter</code>这个类请求用户的授权 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> ([[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] floatValue] &gt;= <span class="number">10.</span>f) &#123; </div><div class="line">        UNUserNotificationCenter *center = [UNUserNotificationCenter currentNotificationCenter];</div><div class="line">        [center setDelegate:[YQUMessage share]];</div><div class="line">        [center requestAuthorizationWithOptions:(UNAuthorizationOptionBadge | UNAuthorizationOptionSound | UNAuthorizationOptionAlert)</div><div class="line">                              completionHandler:^(<span class="built_in">BOOL</span> granted, <span class="built_in">NSError</span> * _Nullable error) &#123;</div><div class="line">                                  <span class="keyword">if</span> (!error &amp;&amp; granted) &#123;</div><div class="line">                                      <span class="built_in">NSLog</span>(<span class="string">@"注册成功"</span>);</div><div class="line">                                  &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                      <span class="built_in">NSLog</span>(<span class="string">@"注册失败"</span>);</div><div class="line">                                  &#125;</div><div class="line">                              &#125;];</div><div class="line">        <span class="comment">/// 通过 getNotificationSettingsWithCompletionHandler 获取用户权限设置, yes or no</span></div><div class="line">        [center getNotificationSettingsWithCompletionHandler:^(UNNotificationSettings * _Nonnull settings) &#123;</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"settings = %@"</span>,settings);</div><div class="line">        &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="二-推送证书配置"><a href="#二-推送证书配置" class="headerlink" title="二. 推送证书配置"></a>二. 推送证书配置</h4><p>2.1    在开发者中心的<code>identifiers</code>中打开<code>Push Notifications</code> 。<br><img src="http://oonis1a4c.bkt.clouddn.com/enable-push.png" alt=""></p>
<p>2.2    在开发者中心的<code>certificates</code>中配置推送证书，证书制作很简单这里就不多说了 。<br><img src="http://oonis1a4c.bkt.clouddn.com/certificates.png" alt=""></p>
<p>2.3    <code>xocde 8</code>环境多了这个选项开关，想要接收推送必须打开 。<br><img src="http://oonis1a4c.bkt.clouddn.com/push-notify.png" alt=""></p>
<h4 id="三-接收推送消息内容"><a href="#三-接收推送消息内容" class="headerlink" title="三. 接收推送消息内容"></a>三. 接收推送消息内容</h4><h5 id="iOS-10之前接收推送消息的方法"><a href="#iOS-10之前接收推送消息的方法" class="headerlink" title=" iOS 10之前接收推送消息的方法 "></a><strong><em> iOS 10之前接收推送消息的方法 </em></strong></h5><p>3.1    iOS 10 之前，当APP在前台或者后台收到推送时会调用这个方法，<code>userInfo</code>就是推送的消息体 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didReceiveRemoteNotification:(<span class="keyword">nonnull</span> <span class="built_in">NSDictionary</span> *)userInfo &#123;</div><div class="line">    <span class="comment">/// 封装的友盟推送类，当应用处于前台活跃状态时收到推送显示自定义的Alert 。</span></div><div class="line">    [YQUMessage showCustomAlertWithUserInfo:userInfo];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.2    （可选）打开<code>background modes</code>开关，勾选<code>remote notifications</code>，可以实现静默推送 。<br><img src="http://oonis1a4c.bkt.clouddn.com/background-modes.png" alt=""> </p>
<p>3.3    静默推送会调用下面这个方法，在<code>completionHandler</code>这个block回调中刷新数据，上面的方法则不会被调用了，<code>userInfo</code>就是推送的消息体 。<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didReceiveRemoteNotification:(<span class="built_in">NSDictionary</span> *)userInfo fetchCompletionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIBackgroundFetchResult</span>))completionHandler &#123;</div><div class="line">    <span class="comment">/// 封装的友盟推送类，当应用处于前台活跃状态时收到推送显示自定义的Alert 。</span></div><div class="line">    [YQUMessage showCustomAlertWithUserInfo:userInfo];</div><div class="line">    completionHandler(userInfo ? <span class="built_in">UIBackgroundFetchResultNewData</span> : <span class="built_in">UIBackgroundFetchResultNoData</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="iOS-10之后接收推送消息新的方法"><a href="#iOS-10之后接收推送消息新的方法" class="headerlink" title=" iOS 10之后接收推送消息新的方法 "></a><strong><em> iOS 10之后接收推送消息新的方法 </em></strong></h5><p>iOS 10之后统一使用<code>UNUserNotificationCenter</code>这个通知类，只要遵守<code>UNUserNotificationCenterDelegate</code>委托协议，实现两个委托方法（分别是当应用在前台和后台的处理）就能处理接收到的推送消息，在iOS 10之前不管前台后台都是在同一个方法中处理的 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// iOS10新增: 处理前台收到通知的代理方法</span></div><div class="line">- (<span class="keyword">void</span>)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(<span class="keyword">void</span> (^)(UNNotificationPresentationOptions))completionHandler &#123;</div><div class="line">    <span class="built_in">NSDictionary</span> *userInfo = notification.request.content.userInfo;</div><div class="line">    <span class="keyword">if</span>([notification.request.trigger isKindOfClass:[UNPushNotificationTrigger <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="comment">/// 显示自定义弹窗</span></div><div class="line">        [YQUMessage showCustomAlertWithUserInfo:userInfo];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/// 应用处于前台时的本地推送接受</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/// 应用处于前台时, 自定义了弹框, 不需要系统的顶部弹窗, UNNotificationPresentationOptionAlert</span></div><div class="line">    completionHandler(UNNotificationPresentationOptionSound | UNNotificationPresentationOptionBadge);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/// iOS10新增: 处理后台点击通知的代理方法</span></div><div class="line">- (<span class="keyword">void</span>)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(<span class="keyword">void</span> (^)())completionHandler &#123;</div><div class="line">    <span class="built_in">NSDictionary</span> *userInfo = response.notification.request.content.userInfo;</div><div class="line">    <span class="keyword">if</span>([response.notification.request.trigger isKindOfClass:[UNPushNotificationTrigger <span class="keyword">class</span>]]) &#123;</div><div class="line">        <span class="comment">/// 显示自定义弹窗</span></div><div class="line">        [YQUMessage showCustomAlertWithUserInfo:userInfo];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">/// 应用处于后台时的本地推送接受</span></div><div class="line">    &#125;</div><div class="line">    completionHandler();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>完成以上步骤之后，其实已经可以实现基本的消息推送了 。在友盟后台分别上传开发和生产环境的<code>p12</code>证书文件，切换到测试模式，添加测试设备的<code>Device Token</code>，添加测试消息就可以进行推送测试，当然只有添加到测试列表的手机能收到 。</p>
<p>如何拿到<code>deviceToken</code>？通过下面这个方法里面可以获取，需要使用以下过滤字符串的方式才能打印出正确的Token值 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didRegisterForRemoteNotificationsWithDeviceToken:(<span class="built_in">NSData</span> *)deviceToken &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"deviceToken = %@"</span>,[[[deviceToken description] stringByTrimmingCharactersInSet:</div><div class="line">                                [<span class="built_in">NSCharacterSet</span> characterSetWithCharactersInString:<span class="string">@"&lt;&gt;"</span>]]</div><div class="line">                               stringByReplacingOccurrencesOfString:<span class="string">@" "</span> withString:<span class="string">@""</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>到这里前面的都已经没有问题了，让我们来加两个处理通知的按钮试试 。先来看看如何创建动作按钮，<code>iOS 8</code> 和 <code>iOS 10</code> 的方法也是不一样的啊 。 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#pragma mark - iOS 8</span></div><div class="line">	<span class="comment">/// 查看按钮</span></div><div class="line">        <span class="built_in">UIMutableUserNotificationAction</span> *open = [[<span class="built_in">UIMutableUserNotificationAction</span> alloc] init];</div><div class="line">        [open setActivationMode:<span class="built_in">UIUserNotificationActivationModeForeground</span>];</div><div class="line">        [open setIdentifier:kOpenActionIdentifier];</div><div class="line">        [open setTitle:locStr(<span class="string">@"notify.open"</span>)];</div><div class="line">        [open setAuthenticationRequired:<span class="literal">YES</span>];</div><div class="line">        [open setDestructive:<span class="literal">NO</span>];</div><div class="line">        </div><div class="line">        <span class="comment">/// 忽略按钮</span></div><div class="line">        <span class="built_in">UIMutableUserNotificationAction</span> *ignore = [[<span class="built_in">UIMutableUserNotificationAction</span> alloc] init];</div><div class="line">        [ignore setActivationMode:<span class="built_in">UIUserNotificationActivationModeBackground</span>];</div><div class="line">        [ignore setIdentifier:kIgnoreActionIdentifier];</div><div class="line">        [ignore setTitle:locStr(<span class="string">@"notify.ignore"</span>)];</div><div class="line">        [ignore setAuthenticationRequired:<span class="literal">NO</span>];</div><div class="line">        [ignore setDestructive:<span class="literal">YES</span>];</div><div class="line">        </div><div class="line">        <span class="comment">/// 创建动作(按钮)的类别集合</span></div><div class="line">        <span class="built_in">UIMutableUserNotificationCategory</span> *categorys = [[<span class="built_in">UIMutableUserNotificationCategory</span> alloc] init];</div><div class="line">        [categorys setActions:@[open, ignore] forContext:(<span class="built_in">UIUserNotificationActionContextDefault</span>)];</div><div class="line">        [categorys setIdentifier:kNotifityCategoryIdentifier]; </div><div class="line"></div><div class="line"><span class="meta">#pragma mark - iOS 10 </span></div><div class="line"> 	UNNotificationAction *open;</div><div class="line">        open = [UNNotificationAction actionWithIdentifier:kOpenActionIdentifier</div><div class="line">                                                    title:locStr(<span class="string">@"notify.open"</span>)     <span class="comment">/// 查看</span></div><div class="line">                                                  options:UNNotificationActionOptionForeground];</div><div class="line">        UNNotificationAction *ignore;</div><div class="line">        ignore = [UNNotificationAction actionWithIdentifier:kIgnoreActionIdentifier</div><div class="line">                                                      title:locStr(<span class="string">@"notify.ignore"</span>) <span class="comment">/// 忽略</span></div><div class="line">                                                    options:UNNotificationActionOptionForeground];</div><div class="line">        UNNotificationCategory *categorys;</div><div class="line">        categorys = [UNNotificationCategory categoryWithIdentifier:kNotifityCategoryIdentifier</div><div class="line">                                                           actions:@[open, ignore]   <span class="comment">/// 创建动作(按钮)的类别集合</span></div><div class="line">                                                 intentIdentifiers:@[kOpenActionIdentifier,kIgnoreActionIdentifier]</div><div class="line">                                                           options:UNNotificationCategoryOptionCustomDismissAction];</div><div class="line">        [center setNotificationCategories:[<span class="built_in">NSSet</span> setWithObjects:categorys, <span class="literal">nil</span>]];</div></pre></td></tr></table></figure>
<p>当应用在后台收到推送消息时，下拉的通知栏列表是这样的，向左划出现按钮，如下图：</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/push-notify-003.jpg?imageView/2/w/600/h/450" alt=""></p>
<p>点击 <code>X</code> 和 <code>忽略</code> 按钮效果是一样的，都会将消息从通知列表中移除，当点击<code>查看</code>按钮的时候会唤起APP进入前台，并调用接收通知的方法 。<br>but，问题来了，当点击<code>查看</code>按钮唤起APP时并没有调用接收推送消息的方法，导致获取不到推送的消息内容，无法做后面的逻辑操作 。<br>这里必须吐槽下友盟的技术支持，在论坛发帖几天没人理，后来发邮件才有人回应，但是依然找不到问题所在（估计是封装的SDK代码有问题），友盟官方也没有后续的回应；最后参考了大部分APP的推送，发现都没有加这个，并且考虑到公司应用实际业务需求，所以最终也还是没有加上这个按钮 。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/// 加了动作按钮后不会调用这两个方法中的任意一个，即使没有开静默推送</span></div><div class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didReceiveRemoteNotification:(<span class="keyword">nonnull</span> <span class="built_in">NSDictionary</span> *)userInfo &#123; </div><div class="line">&#125; </div><div class="line"><span class="comment">/// 静默推送调用</span></div><div class="line">- (<span class="keyword">void</span>)application:(<span class="built_in">UIApplication</span> *)application didReceiveRemoteNotification:(<span class="built_in">NSDictionary</span> *)userInfo fetchCompletionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIBackgroundFetchResult</span>))completionHandler &#123; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>下面最后一段代码是我封装的类方法，不管是iOS 10之前还是之后，在前台还是后台，都统一在这里面处理收到的推送消息，其中<code>type</code>和<code>url</code>字段为和后台约定好的自定义字段，用于是否需要跳转展示webview 。当然，以后可能需要跳转到指定的页面，只要和后台约定好要跳转的页面定义好推送字段，也是可以在这里处理的 。 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)showCustomAlertWithUserInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</div><div class="line">    </div><div class="line">    __<span class="keyword">weak</span> <span class="keyword">typeof</span>([YQUMessage share]) weakSelf = [YQUMessage share];</div><div class="line">    <span class="keyword">if</span> ([<span class="built_in">UIApplication</span> sharedApplication].applicationState == <span class="built_in">UIApplicationStateActive</span>) &#123;</div><div class="line">        [[YQUMessage share] mainAsyncQueue:^&#123;</div><div class="line">            <span class="comment">/// 关闭友盟弹窗</span></div><div class="line">            [UMessage setAutoAlert:<span class="literal">NO</span>];</div><div class="line">            <span class="comment">/// 自定义弹窗</span></div><div class="line">            [[YQCustomAlertView alertWithImage:<span class="literal">nil</span></div><div class="line">                                         title:userInfo[<span class="string">@"aps"</span>][<span class="string">@"alert"</span>][<span class="string">@"title"</span>]</div><div class="line">                                       message:userInfo[<span class="string">@"aps"</span>][<span class="string">@"alert"</span>][<span class="string">@"body"</span>]</div><div class="line">                                cancelBtnTitle:locStr(!userInfo[<span class="string">@"type"</span>] ? <span class="string">@"notify.ignore"</span> : <span class="literal">nil</span>)</div><div class="line">                                 otherBtnTitle:locStr(!userInfo[<span class="string">@"type"</span>] ? <span class="string">@"notify.open"</span> : <span class="string">@"notify.gotIt"</span>)</div><div class="line">                               clickIndexBlock:^(<span class="built_in">NSInteger</span> clickIndex) &#123;</div><div class="line">                                   </div><div class="line">                                   <span class="keyword">if</span> (userInfo[<span class="string">@"type"</span>] &amp;&amp; !clickIndex)</div><div class="line">                                       <span class="comment">/// 补发消息点击事件，以便在友盟后台统计点击数</span></div><div class="line">                                       [UMessage sendClickReportForRemoteNotification:userInfo];</div><div class="line">                                   </div><div class="line">                                   <span class="keyword">if</span> (clickIndex) &#123;</div><div class="line">                                       YQWebViewController *webVC = [[YQWebViewController alloc] init];</div><div class="line">                                       [webVC setRequestStyle:RequestStyleUrlStr];</div><div class="line">                                       [webVC setUrlStr:[userInfo valueForKey:<span class="string">@"url"</span>]];</div><div class="line">                                       [[weakSelf getCurrentVC].navigationController pushViewController:webVC animated:<span class="literal">YES</span>];</div><div class="line">                                       [UMessage sendClickReportForRemoteNotification:userInfo];</div><div class="line">                                   &#125;</div><div class="line">                                   </div><div class="line">                               &#125; animationStyle:AnimationStyleDefault] showAlertView];</div><div class="line">        &#125;];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (userInfo[<span class="string">@"url"</span>] &amp;&amp; [userInfo[<span class="string">@"url"</span>] length]) &#123;</div><div class="line">            YQWebViewController *webVC = [[YQWebViewController alloc] init];</div><div class="line">            [webVC setRequestStyle:RequestStyleUrlStr];</div><div class="line">            [webVC setUrlStr:[userInfo valueForKey:<span class="string">@"url"</span>]];</div><div class="line">            [[weakSelf getCurrentVC].navigationController pushViewController:webVC animated:<span class="literal">YES</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/// 应用处于运行时（前台、后台）的消息处理</span></div><div class="line">        [UMessage didReceiveRemoteNotification:userInfo];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oonis1a4c.bkt.clouddn.com/umeng-push.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;最近项目需要做消息推送，于是决定使用第三方推送服务（为了方便后台统一iOS和Android的消息管理）；目前做消息推送的服务商
    
    </summary>
    
      <category term="Technology" scheme="http://yoursite.com/categories/Technology/"/>
    
      <category term="iOS" scheme="http://yoursite.com/categories/Technology/iOS/"/>
    
    
      <category term="iOS" scheme="http://yoursite.com/tags/iOS/"/>
    
      <category term="推送" scheme="http://yoursite.com/tags/%E6%8E%A8%E9%80%81/"/>
    
  </entry>
  
  <entry>
    <title>利用 Hexo 搭建博客</title>
    <link href="http://yoursite.com/2017/04/19/hello-hexo/"/>
    <id>http://yoursite.com/2017/04/19/hello-hexo/</id>
    <published>2017-04-19T07:35:34.000Z</published>
    <updated>2017-05-20T12:21:14.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://oonis1a4c.bkt.clouddn.com/hexo-logo.png" alt=""></p>
<p>看到越来越多人搭建了漂亮的个人博客网站，一直心里痒痒想着自己也弄一个，刚好最近项目告一段落了有点空闲时间，于是网上找了教程就开始(zhuangbility)啦！</p>
<p>当然写本文的目的只是为了记录我自己的搭建过程及踩的坑，更详细的建站等细节大家可以查看<a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="external">Hexo的官方文档</a>，而且本文只是针对Mac OSX 系统平台, Windows系统的表示不会(话说很多年没用过了，忘记Windows长啥样啦(づ｡◕‿‿◕｡)づ)。所以还是建议大家看官方文档吧，各平台都有说明，好啦，废话不多说。</p>
<p>目前搭建免费博客有两种方式：<br>一是：<code>github Pages + Hexo</code>； 二是：<code>github Pages + Jekyll</code>；<br>两者都是利用github既免费又稳定的空间作为托管，对比了下，<strong>Hexo</strong> 更简洁高效更多人使用，有非常详细的建站文档，当然 <strong>Jekyll</strong> 也有文档提供，感兴趣的童鞋可以<a href="http://jekyllcn.com/docs/home/" target="_blank" rel="external">看这里</a>，但是相比Hexo定制性更高，更有丰富的Theme可以自定义，如果你是一名前端开发者，甚至可以自己写Theme；so！Hexo 绝对是爱折腾兼完美主义者的不二之选。</p>
<h3 id="一-Github-Account"><a href="#一-Github-Account" class="headerlink" title="一. Github Account"></a>一. Github Account</h3><p>对于一个开发者来说，以下步骤我想可以忽略吧。</p>
<p>1.1. 你需要一个GitHub帐号，到<a href="https://github.com/" target="_blank" rel="external">GitHub官网</a>按照步骤注册即可。</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/join-github.png" alt="join GitHub"></p>
<p>1.2. 注册成功后，你需要创建一个新的仓库。</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/new-repo.png?imageView/1/w/500/h/300" alt="new repository"> </p>
<p>1.3. 创建仓库过程说明，这里需要注意的是仓库名称的命名规则，必须是<code>注册名.github.io</code>这种格式，后续就可以通过<code>https://注册名.github.io/</code>来访问你的博客网站啦。</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/create-repo.png" alt="create repository"></p>
<h3 id="二-环境准备"><a href="#二-环境准备" class="headerlink" title="二. 环境准备"></a>二. 环境准备</h3><h3 id="1-Git"><a href="#1-Git" class="headerlink" title="1. Git"></a>1. <a href="https://git-scm.com/" target="_blank" rel="external">Git</a></h3><p>首先安装Git，后续的操作全部依赖它，安装教程<a href="https://git-scm.com/book/zh/v2/%E8%B5%B7%E6%AD%A5-%E5%AE%89%E8%A3%85-Git" target="_blank" rel="external">看官方文档</a>So Easy，或者自行Google。<br>PS: 相信做开发的童鞋都不陌生, iOS 开发者更不用说，xcode 自带！</p>
<h3 id="2-Node-js"><a href="#2-Node-js" class="headerlink" title="2. Node.js"></a>2. <a href="https://nodejs.org/en/" target="_blank" rel="external">Node.js</a></h3><p>在安装Node之前，需要先安装Node版本管理工具<code>nvm</code>，用于Node版本切换，安装方式有两种，先来看第一种，<a href="https://brew.sh/index_zh-cn.html" target="_blank" rel="external">Homebrew</a> 安装方式，比较麻烦，并且这种方式安装后Node版本切换有问题，因此不推荐这种方式，安装完后不需要重启终端，依次执行下列命令即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ brew install nvm  </div><div class="line">$ mkdir ~/.nvm</div><div class="line">$ export NVM_DIR=~/.nvm</div><div class="line">$ . $(brew --prefix nvm)/nvm.sh</div></pre></td></tr></table></figure>
<p>第二种安装方式：</p>
<p><strong>curl</strong>安装方式，如果没有使用<code>Homebrew</code>安装过，直接跳过前面的命令执行最后一条即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 查看已经安装在全局的模块，以便删除这些全局模块后再按照不同的 node 版本重新进行全局安装 </div><div class="line">$ npm ls -g --depth=0 </div><div class="line"></div><div class="line"># 删除全局 node_modules 目录</div><div class="line">$ sudo rm -rf /usr/local/lib/node_modules </div><div class="line"></div><div class="line"># 删除 node </div><div class="line">$ sudo rm /usr/local/bin/node </div><div class="line"></div><div class="line"># 删除全局 node 模块注册的软链</div><div class="line">$ cd /usr/local/bin &amp;&amp; ls -l | grep &quot;../lib/node_modules/&quot; | awk &apos;&#123;print $9&#125;&apos;| xargs rm  </div><div class="line"></div><div class="line"># 最后，安装nvm的正确姿势</div><div class="line">$ curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.1/install.sh | bash</div></pre></td></tr></table></figure>
<p>然后可以看到下载<code>nvm</code>成功并安装，并且在<code>~/.zshrc</code>中已经自动加入了环境变量，现在需要重启你的终端。（什么是<code>zshrc</code>？后面再专门写篇文章来讲，这里先略过）</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/install-nvm.png" alt="install nvm"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export NVM_DIR=&quot;$HOME/.nvm&quot;</div><div class="line">[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; \. &quot;$NVM_DIR/nvm.sh&quot;  # This loads nvm</div></pre></td></tr></table></figure>
<p>这里附上一篇<a href="http://www.imooc.com/article/14617" target="_blank" rel="external">《正确的安装和使用nvm(mac)》</a>文章链接，写的非常详细，大家可以参考。 </p>
<p>重启终端后，执行以下命令即可安装<strong>Node.js</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 安装node，版本5以上</div><div class="line">$ nvm install 5</div></pre></td></tr></table></figure>
<p><img src="http://oonis1a4c.bkt.clouddn.com/install-node.png" alt="install node"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 查看node版本</div><div class="line">$ nvm ls</div></pre></td></tr></table></figure>
<h3 id="3-Hexo"><a href="#3-Hexo" class="headerlink" title="3. Hexo"></a>3. <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a></h3><p>以上环境安装完了，最后我们就可以安装<strong>Hexo</strong>啦！<br>执行以下命令，这里需要申请sudo权限，输入管理员密码即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 安装hexo</div><div class="line">$ sudo npm install hexo-cli -g</div></pre></td></tr></table></figure>
<p>此时命令行哗啦啦输出好多东西，稍等片刻就安装好了。</p>
<p><img src="http://oonis1a4c.bkt.clouddn.com/install-hexo.png" alt="install hexo"></p>
<p>最后，再安装 <strong><a href="$ npm install hexo-deployer-git --save">博客自动部署工具</a></strong> 帮助我们将编写的文章发布并部署到github服务器。<br>注意后面的<code>--save</code>一定要带上，不然部署到github时会报错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 安装git自动部署工具</div><div class="line">$ npm install hexo-deployer-git --save</div></pre></td></tr></table></figure>
<p><strong><em>到此为止，已经成功安装好所有环境，建站完成。Yahoo！</em></strong></p>
<h3 id="三-网站配置"><a href="#三-网站配置" class="headerlink" title="三. 网站配置"></a>三. 网站配置</h3><p>建站完成后，在根目录<code>xxx.github.io</code>文件夹的目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── _config.yml		# 网站的 配置 信息，可以在这里配置大部分的参数。</div><div class="line">├── db.json		# 缓存文件</div><div class="line">├── debug.log		# 调试信息</div><div class="line">├── node_modules	# 安装的node文件夹</div><div class="line">├── nvm			# 安装的nvm文件</div><div class="line">├── package.json 	# 应用程序的信息。</div><div class="line">├── scaffolds		# 模版文件夹，新建文章时，Hexo 会根据 scaffold 来建立文件。</div><div class="line">├── source		# 资源文件夹是存放用户资源的地方。除 _posts 文件夹之外，开头命名为 _ (下划线)的文件 / 文件夹和隐藏的文件将会被忽略。 </div><div class="line">|   ├── _drafts		# 草稿。</div><div class="line">|   └── _posts		# 新建的文章.md 会放到这个文件夹。</div><div class="line">└── themes		# 主题文件夹，Hexo 会根据主题来生成静态页面。</div></pre></td></tr></table></figure>
<p>若要修改网站配置，使用vim编辑器打开<code>_config.yml</code>文件，按<code>i</code>即可进行编辑。<br>以下是我的站点配置，你需要修改的是你的网站标题和最下面的<code>deploy</code>配置，修改<code>repo</code>为你的github仓库地址即可，其它可选；</p>
<p>说一下<code>theme</code>字段，这个是主题设置，默认为<code>next</code>主题，我选择的是<a href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank" rel="external">Hueman</a>主题，更多主题可以<a href="https://hexo.io/themes/" target="_blank" rel="external">看这里</a>，实在太多，任君选择。（主题替换还是有点坑，后面再写一篇文章专门讲）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"># Hexo Configuration             # hexo 配置</div><div class="line">## Docs: https://hexo.io/docs/configuration.html</div><div class="line">## Source: https://github.com/hexojs/hexo/</div><div class="line"></div><div class="line"># Site                           # 网站</div><div class="line">title: Arvin&apos;s                   # 网站标题</div><div class="line">subtitle: Arvin&apos;s blog           # 网站副标题</div><div class="line">description: 有幸站在互联网技术革命的浪潮之上, 奋勇前行. # 网站描述</div><div class="line">author: Arvin&apos;s                  # 您的名字</div><div class="line">language: zh-CN                  # 网站使用的语言</div><div class="line">timezone:                        # 网站时区。Hexo 默认使用您电脑的时区。时区列表。比如说：America/New_York, Japan, 和 UTC 。</div><div class="line"></div><div class="line"># URL                            # 链接格式</div><div class="line">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</div><div class="line">url: http://yoursite.com                # 网址</div><div class="line">root: /                                 # 网站根目录</div><div class="line">permalink: :year/:month/:day/:title/    # 文章的 永久链接 格式</div><div class="line">permalink_defaults:                     # 永久链接中各部分的默认值</div><div class="line"></div><div class="line"># RSS订阅支持</div><div class="line">plugin:</div><div class="line">- hexo-generator-feed</div><div class="line"></div><div class="line"># Feed Atom</div><div class="line">feed:</div><div class="line">type: atom</div><div class="line">path: atom.xml</div><div class="line">limit: 20</div><div class="line"></div><div class="line"># Directory                      # 目录</div><div class="line">source_dir: source               # 资源文件夹，这个文件夹用来存放内容。</div><div class="line">public_dir: public               # 公共文件夹，这个文件夹用于存放生成的站点文件。</div><div class="line">tag_dir: tags                    # 标签文件夹</div><div class="line">archive_dir: archives            # 归档文件夹</div><div class="line">category_dir: categories         # 分类文件夹</div><div class="line">code_dir: downloads/code         # Include code 文件夹</div><div class="line">i18n_dir: :lang                  # 国际化（i18n）文件夹</div><div class="line">skip_render:                     # 跳过指定文件的渲染，您可使用 glob 表达式来匹配路径。</div><div class="line"></div><div class="line"># Writing                                               # 文章</div><div class="line">new_post_name: :title.md # File name of new posts       # 新文章的文件名称</div><div class="line">default_layout: post                                    # 预设布局</div><div class="line">titlecase: false # Transform title into titlecase       # 把标题转换为 title case</div><div class="line">external_link: true # Open external links in new tab    # 在新标签中打开链接</div><div class="line">filename_case: 0                                        # 把文件名称转换为 (1) 小写或 (2) 大写</div><div class="line">render_drafts: false                                    # 显示草稿</div><div class="line">post_asset_folder: false                                # 启动 Asset 文件夹</div><div class="line">relative_link: false                                    # 把链接改为与根目录的相对位址</div><div class="line">future: true                                            # 显示未来的文章</div><div class="line">highlight:                                              # 代码块的设置</div><div class="line">  enable: true                   # 是否启用</div><div class="line">  line_number: true              # 显示行号</div><div class="line">  auto_detect: false             #</div><div class="line">  tab_replace:</div><div class="line"></div><div class="line"># Category &amp; Tag                 # 分类和标签</div><div class="line">default_category: uncategorized  # 默认分类</div><div class="line">category_map:                    # 分类别名</div><div class="line">tag_map:                         # 标签别名</div><div class="line"></div><div class="line"># Date / Time format             # 日期时间格式</div><div class="line">## Hexo uses Moment.js to parse and display date</div><div class="line">## You can customize the date format as defined in</div><div class="line">## http://momentjs.com/docs/#/displaying/format/</div><div class="line">date_format: YYYY-MM-DD          # 日期格式</div><div class="line">time_format: HH:mm:ss            # 时间格式</div><div class="line"></div><div class="line"># Pagination                     # 分页</div><div class="line">## Set per_page to 0 to disable pagination</div><div class="line">per_page: 10                     # 每页显示的文章量 (0 = 关闭分页功能)</div><div class="line">pagination_dir: page             # 分页目录</div><div class="line"></div><div class="line"># Extensions                     # 拓展插件</div><div class="line">## Plugins: https://hexo.io/plugins/</div><div class="line">## Themes: https://hexo.io/themes/</div><div class="line">theme: hueman                    # 当前主题名称。值为false时禁用主题</div><div class="line"></div><div class="line"># Deployment                     # 部署</div><div class="line">## Docs: https://hexo.io/docs/deployment.html</div><div class="line">deploy:                          # 部署部分的设置</div><div class="line">  type: git</div><div class="line">  repo: git@github.com:kejiasir/kejiasir.github.io.git</div><div class="line">  branch: master</div><div class="line">  message:</div></pre></td></tr></table></figure>
<h3 id="四-文章发布"><a href="#四-文章发布" class="headerlink" title="四. 文章发布"></a>四. 文章发布</h3><h4 id="1-文章新建"><a href="#1-文章新建" class="headerlink" title="1. 文章新建"></a>1. 文章新建</h4><p>执行下列命令来创建一篇新文章。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># layout 可以不写，默认为post，可以通过修改 _config.yml 中的 default_layout 参数来指定默认布局。</div><div class="line"># title 文章标题，如果有空格，需使用双引号包括，例：“hello world”。</div><div class="line">$ hexo new [layout] &lt;title&gt;</div></pre></td></tr></table></figure></p>
<h4 id="2-文章布局"><a href="#2-文章布局" class="headerlink" title="2. 文章布局"></a>2. 文章布局</h4><p>Hexo 有三种默认布局：<code>page</code> 、<code>post</code>和 <code>draft</code>，它们分别对应不同的路径，如果你自定义布局将和 <code>post</code> 一样，都会储存到 <code>source/_posts</code> 这个文件夹。 </p>
<table>
<thead>
<tr>
<th>布局</th>
<th style="text-align:center">路径</th>
</tr>
</thead>
<tbody>
<tr>
<td>page</td>
<td style="text-align:center">source</td>
</tr>
<tr>
<td>post</td>
<td style="text-align:center">source/_posts</td>
</tr>
<tr>
<td>draft</td>
<td style="text-align:center">source/_drafts</td>
</tr>
</tbody>
</table>
<h4 id="3-草稿"><a href="#3-草稿" class="headerlink" title="3. 草稿"></a>3. 草稿</h4><p>Hexo 的一种特殊布局：<code>draft</code>，这种布局在建立时会被保存到 <code>source/_drafts</code> 文件夹，可以通过 <code>publish</code> 命令将草稿移动到 <code>source/_posts</code> 文件夹，该命令的使用方式与 <code>new</code> 十分类似，你也可以在命令中指定 layout 来设置布局（文章路径）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 把 source/_drafts 文件夹内的文章移动到 source/_posts 文件夹中</div><div class="line">$ hexo publish [layout] &lt;title&gt;</div></pre></td></tr></table></figure>
<h4 id="4-文章编写"><a href="#4-文章编写" class="headerlink" title="4. 文章编写"></a>4. 文章编写</h4><p>上面说到新建的文章不指定布局会默认保存在<code>source/_posts</code>路径下，新建文章后缀格式为<code>.md</code>文件，即需要使用<a href="http://www.markdown.cn/" target="_blank" rel="external">Markdown</a>语法编写，你可以使用<code>vim</code>编辑器进行编辑，但是可想而知那有多么恶心。所以还是选择一款专业的markdown编辑器吧，Mac平台的 <a href="https://www.macupdate.com/app/mac/40420/mou" target="_blank" rel="external">Mou</a> 编辑器不错；而我自己用的是 <a href="http://zh.mweb.im/" target="_blank" rel="external">MWeb Lite</a> 免费版（国内开发者良心之作），体验已经非常不错，目前足以满足我的需求了，当然土豪可以购买收费版的支持下，据说功能足够强大。</p>
<p>文章编辑完成后，使用以下命令进行本地测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 启动服务器，你可以在浏览器中输入 http://localhost:4000/. 来访问你的博客网站，查看文章</div><div class="line">$ hexo server		---&gt;&gt;&gt; 可以简写为  hexo s</div></pre></td></tr></table></figure>
<h4 id="5-文章发布"><a href="#5-文章发布" class="headerlink" title="5. 文章发布"></a>5. 文章发布</h4><p>当然你可以随时在markdown编辑器中修改文章，记得存储（command+s），直到你想要部署到github，使用以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 清除缓存文件 (db.json) 和已生成的静态文件 (public)</div><div class="line">$ hexo clean		</div><div class="line"></div><div class="line"># 生成缓存和静态文件</div><div class="line">$ hexo generate		---&gt;&gt;&gt; 可以简写为  hexo g </div><div class="line"></div><div class="line"># 重新部署到服务器</div><div class="line">$ hexo deploy		---&gt;&gt;&gt; 可以简写为  hexo d</div></pre></td></tr></table></figure>
<p>到此，如无意外，你已经顺利部署文章到github服务器，快使用<code>https://注册名.github.io/</code>域名来访问你的博客网站，看看发布的文章吧。（域名绑定还没有弄，后面弄好了在写）  </p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://oonis1a4c.bkt.clouddn.com/hexo-logo.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;看到越来越多人搭建了漂亮的个人博客网站，一直心里痒痒想着自己也弄一个，刚好最近项目告一段落了有点空闲时间，于是网上找了教程就开始
    
    </summary>
    
      <category term="Technology" scheme="http://yoursite.com/categories/Technology/"/>
    
      <category term="Hexo" scheme="http://yoursite.com/categories/Technology/Hexo/"/>
    
    
      <category term="Hexo" scheme="http://yoursite.com/tags/Hexo/"/>
    
  </entry>
  
</feed>
